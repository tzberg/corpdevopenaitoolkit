<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>CorpDev AI Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          rel="stylesheet">
    <style>
        :root {
          --bg: #020617; --panel: #0f172a; --card: #1e293b; --hover: #334155;
          --fg: #f1f5f9; --muted: #94a3b8; --accent: #3b82f6; --accent-hover: #2563eb;
          --success: #10b981; --warn: #f59e0b; --danger: #ef4444; --border: #334155;
          --gradient: linear-gradient(135deg, #3b82f6 0%, #7c3aed 100%);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
          background: var(--bg); color: var(--fg);
          font: 14px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .app-container { display: flex; height: 100vh; overflow: hidden; }
        .sidebar {
          width: 280px; background: var(--panel); border-right: 1px solid var(--border);
          display: flex; flex-direction: column;
        }
        .logo {
          padding: 20px; border-bottom: 1px solid var(--border);
          background: var(--gradient); color: white;
          display: flex; align-items: center; gap: 12px;
        }
        .logo-icon { font-size: 20px; }
        .logo h1 { font-size: 18px; font-weight: 700; }
        .nav-section { padding: 16px; }
        .nav-title {
          padding: 0 0 8px; font-size: 11px; font-weight: 600; color: var(--muted);
          text-transform: uppercase; letter-spacing: 0.5px;
        }
        .nav-item {
          display: flex; align-items: center; gap: 12px; padding: 12px 16px;
          cursor: pointer; transition: all 0.2s ease; color: var(--muted);
          margin: 2px 0; border-radius: 8px;
        }
        .nav-item:hover { background: var(--hover); color: var(--fg); }
        .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--accent); font-weight: 500; }
        .nav-icon { width: 20px; text-align: center; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header {
          background: var(--panel); border-bottom: 1px solid var(--border);
          padding: 16px 24px; display: flex; justify-content: space-between; align-items: center;
        }
 .header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-right .status-badge {
  margin-top: 1px;       /* tiny vertical nudge */
  line-height: 1.2;      /* gives room for dot + text */
  display: flex;         /* force flex layout */
  align-items: center;   /* vertically center dot + text */
}

.header-right .btn-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 36px;          /* match badge height */
  width: 36px;
  padding: 0;
}

        .content-area { flex: 1; overflow-y: auto; padding: 24px; }
        .card {
          background: var(--card); border: 1px solid var(--border); border-radius: 12px;
          margin-bottom: 24px; overflow: hidden;
        }
        .card-header {
          padding: 20px 24px; border-bottom: 1px solid var(--border);
          display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 18px; font-weight: 600; }
        .card-body { padding: 24px; }
        .btn {
          display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px;
          border: none; border-radius: 8px; font-weight: 500; cursor: pointer;
          transition: all 0.2s ease; font-size: 14px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--hover); color: var(--fg); }
        .btn-icon { padding: 8px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-group { margin-bottom: 20px; }
        .form-label {
          display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;
        }
        .form-label .required { color: var(--danger); margin-left: 4px; }
        .form-label .optional { color: var(--muted); font-size: 12px; margin-left: 8px; font-weight: 400; }
        .form-helper { font-size: 12px; color: var(--muted); margin-top: 4px; }
        .form-input, .form-textarea {
          width: 100%; padding: 12px 16px; border: 2px solid var(--border);
          border-radius: 8px; background: var(--bg); color: var(--fg);
          transition: all 0.2s ease; font-size: 14px; font-family: inherit;
        }
        .form-input:focus, .form-textarea:focus {
          outline: none; border-color: var(--accent);
        }
        .form-textarea { min-height: 100px; resize: vertical; }
        .grid { display: grid; gap: 16px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .col-span-2 { grid-column: span 2; }
        .module-card {
          background: var(--card); border: 2px solid var(--border); border-radius: 12px;
          padding: 20px; cursor: pointer; transition: all 0.3s ease;
        }
        .module-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .module-card.selected { border-color: var(--accent); background: rgba(59, 130, 246, 0.05); }
        .module-icon {
          width: 48px; height: 48px; border-radius: 12px;
          background: var(--gradient); display: flex; align-items: center; justify-content: center;
          color: white; font-size: 20px; margin-bottom: 16px;
        }
        .module-name { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .module-desc { color: var(--muted); font-size: 13px; line-height: 1.4; }
        .status-badge {
          display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px;
          border-radius: 20px; font-size: 12px; font-weight: 500;
        }
        .status-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .status-warning { background: rgba(245, 158, 11, 0.1); color: var(--warn); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-4 { margin-top: 16px; }
        .spinner {
          display: inline-block; width: 16px; height: 16px;
          border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white;
          border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay {
          position: fixed; top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0, 0, 0, 0.75); z-index: 2000;
          display: flex; align-items: center; justify-content: center;
          opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
          background: var(--card); border-radius: 16px; width: 500px; max-width: 90vw;
          border: 1px solid var(--border);
        }
        .modal-header {
          padding: 24px; border-bottom: 1px solid var(--border);
          display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 20px; font-weight: 600; }
        .close-btn {
          background: none; border: none; color: var(--muted);
          cursor: pointer; font-size: 20px; padding: 4px;
        }
        .result-content {
          max-height: 600px; overflow-y: auto; padding: 20px;
          background: var(--bg); border-radius: 8px; border: 1px solid var(--border);
          white-space: pre-wrap; font-family: inherit; line-height: 1.7;
          font-size: 14px;
        }
        .chat-container {
          border: 1px solid var(--border); border-radius: 12px;
          background: var(--card); overflow: hidden; margin-top: 24px;
        }
        .chat-header {
          padding: 16px 20px; border-bottom: 1px solid var(--border);
          font-weight: 600;
        }
        .chat-messages {
          height: 400px; overflow-y: auto; padding: 16px;
        }
        .chat-message {
          margin-bottom: 16px; display: flex;
        }
        .chat-message.user { justify-content: flex-end; }
        .chat-message.assistant { justify-content: flex-start; }
        .chat-bubble {
          max-width: 75%; padding: 12px 16px; border-radius: 12px;
          line-height: 1.5;
        }
        .chat-message.user .chat-bubble {
          background: var(--accent); color: white;
        }
        .chat-message.assistant .chat-bubble {
          background: var(--hover); color: var(--fg);
        }
        .chat-input-container {
          padding: 16px; border-top: 1px solid var(--border);
          display: flex; gap: 12px;
        }
        .chat-input {
          flex: 1; padding: 12px 16px; border: 2px solid var(--border);
          border-radius: 8px; background: var(--bg); color: var(--fg);
        }
        .upload-zone {
          border: 2px dashed var(--border); border-radius: 12px; padding: 40px;
          text-align: center; cursor: pointer; background: rgba(59, 130, 246, 0.02);
          transition: all 0.3s ease; margin-bottom: 16px;
        }
        .upload-zone:hover, .upload-zone.dragover {
          border-color: var(--accent); background: rgba(59, 130, 246, 0.05);
          transform: translateY(-2px);
        }
        .upload-icon { font-size: 48px; color: var(--accent); margin-bottom: 16px; opacity: 0.7; }
        .file-list { margin-top: 16px; }
        .file-item {
          display: flex; align-items: center; justify-content: space-between;
          padding: 12px 16px; background: var(--hover); border-radius: 8px; margin-bottom: 8px;
        }
        .file-info { flex: 1; }
        .file-name { font-weight: 500; font-size: 14px; }
        .file-meta { color: var(--muted); font-size: 12px; margin-top: 2px; }
    </style>
</head>
<body>
<div class="app-container">
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon"><i class="fas fa-chart-line"></i></div>
            <h1>CorpDev AI</h1>
        </div>
        <nav style="flex: 1; overflow-y: auto;">
            <div class="nav-section">
                <div class="nav-title">Workspace</div>
                <div class="nav-item active" data-page="dashboard">
                    <div class="nav-icon"><i class="fas fa-th-large"></i></div>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-page="analysis">
                    <div class="nav-icon"><i class="fas fa-plus-circle"></i>
                    </div>
                    <span>New Analysis</span>
                </div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Quick Access</div>
                <div class="nav-item" data-module="target_sourcing">
                    <div class="nav-icon"><i class="fas fa-search"></i></div>
                    <span>Target Sourcing</span>
                </div>
                <div class="nav-item" data-module="due_diligence">
                    <div class="nav-icon"><i
                            class="fas fa-clipboard-check"></i></div>
                    <span>Due Diligence</span>
                </div>
                <div class="nav-item" data-module="valuation">
                    <div class="nav-icon"><i class="fas fa-calculator"></i>
                    </div>
                    <span>Valuation Analysis</span>
                </div>
                <div class="nav-item" data-module="market_analysis">
                    <div class="nav-icon"><i class="fas fa-chart-area"></i>
                    </div>
                    <span>Market Analysis</span>
                </div>
                <div class="nav-item" data-module="integration">
                    <div class="nav-icon"><i class="fas fa-puzzle-piece"></i>
                    </div>
                    <span>Integration Planning</span>
                </div>
                <div class="nav-item" data-module="synergies">
                    <div class="nav-icon"><i class="fas fa-handshake"></i>
                    </div>
                    <span>Synergy Analysis</span>
                </div>
            </div>
        </nav>
    </aside>

    <main class="main-content">
        <header class="header">
            <h2 id="pageTitle">Dashboard</h2>
            <div class="header-right">
                <div class="status-badge" id="aiStatus">
                    <div class="status-dot"></div>
                    <span>Not Connected</span>
                </div>
                <button class="btn btn-secondary btn-icon" id="settingsBtn">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <div class="content-area">
            <div id="dashboard" class="page">
                <div class="card">
                    <div class="card-body">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">
                            Welcome to CorpDev AI</h3>
                        <p style="color: var(--muted); margin-bottom: 20px;">
                            AI-powered M&A analysis. Quick insights, no
                            fluff.</p>
                        <button class="btn btn-primary" id="startAnalysisBtn">
                            <i class="fas fa-play"></i>
                            Start New Analysis
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Analysis Modules</div>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-3" id="dashboardModules"></div>
                    </div>
                </div>
            </div>

            <div id="analysis" class="page hidden">
                <div id="dealContextCard" class="card hidden">
                    <div class="card-header">
                        <div class="card-title">Deal Context</div>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-2" id="dealContextForm"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Document Upload (Optional)
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="upload-zone" id="uploadZone">
                            <div class="upload-icon"><i
                                    class="fas fa-cloud-upload-alt"></i></div>
                            <div style="font-size: 16px; margin-bottom: 8px; font-weight: 500;">
                                Drop files here or click to browse
                            </div>
                            <div style="color: var(--muted); font-size: 14px;">
                                PDF, CSV, XLSX, TXT, JSON (max 100MB)
                            </div>
                            <input type="file" id="fileInput" multiple
                                   style="display: none;"
                                   accept=".pdf,.csv,.xlsx,.txt,.json">
                        </div>
                        <div class="file-list" id="fileList"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Select Analysis Module</div>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-3" id="moduleSelector"></div>
                        <div class="text-center mt-4">
                            <button class="btn btn-primary" id="runAnalysis"
                                    disabled>
                                <i class="fas fa-play"></i>
                                Run Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="results" class="page hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Analysis Results</div>
                        <button class="btn btn-secondary" id="toggleChat">
                            <i class="fas fa-comments"></i>
                            Chat with AI
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="result-content" id="resultContent"></div>
                    </div>
                </div>

                <div class="chat-container hidden" id="chatContainer">
                    <div class="chat-header">Refine Analysis</div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput"
                               placeholder="Ask a follow-up question...">
                        <button class="btn btn-primary" id="sendChatBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Settings</div>
            <button class="close-btn" id="closeSettings">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">OpenAI API Key</label>
                <input type="password" class="form-input" id="apiKeyInput"
                       placeholder="sk-...">
                <div style="color: var(--muted); font-size: 12px; margin-top: 4px;">
                    Your API key is stored locally in your browser
                </div>
            </div>
            <div style="text-align: right; margin-top: 24px;">
                <button class="btn btn-secondary" id="cancelSettings">Cancel
                </button>
                <button class="btn btn-primary" id="saveSettings"
                        style="margin-left: 8px;">
                    <i class="fas fa-save"></i>
                    Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const App = {
      currentPage: 'dashboard',
      selectedModule: null,
      apiKey: localStorage.getItem('openai_api_key') || '',
      analysisResult: '',
      chatMessages: [],
      formData: {},
      uploads: new Map(),
      moduleConfig: {
        target_sourcing: {
          label: 'Target Sourcing',
          description: 'Identify 30 potential acquisition targets',
          icon: 'fas fa-search',
          fields: [
            { name: 'acquirer', required: true },
            { name: 'targetIndustry', required: false },
            { name: 'geography', required: false },
            { name: 'revenueRange', required: false },
            { name: 'notes', required: false }
          ]
        },
        due_diligence: {
          label: 'Due Diligence',
          description: 'Generate DD framework and checklist',
          icon: 'fas fa-clipboard-check',
          fields: [
            { name: 'acquirer', required: true },
            { name: 'target', required: true },
            { name: 'notes', required: false }
          ]
        },
        valuation: {
          label: 'Valuation Analysis',
          description: 'DCF with base/upside/downside cases',
          icon: 'fas fa-calculator',
          fields: [
            { name: 'acquirer', required: true },
            { name: 'target', required: true },
            { name: 'wacc', required: false },
            { name: 'terminalGrowth', required: false },
            { name: 'taxRate', required: false },
            { name: 'notes', required: false }
          ]
        },
        market_analysis: {
          label: 'Market Analysis',
          description: 'Competition and market dynamics',
          icon: 'fas fa-chart-area',
          fields: [
            { name: 'acquirer', required: true },
            { name: 'targetMarket', required: true },
            { name: 'sampleCompany', required: false },
            { name: 'notes', required: false }
          ]
        },
        integration: {
          label: 'Integration Planning',
          description: 'Post-acquisition integration process',
          icon: 'fas fa-puzzle-piece',
          fields: [
            { name: 'acquirer', required: true },
            { name: 'target', required: true },
            { name: 'notes', required: false }
          ]
        },
        synergies: {
          label: 'Synergy Analysis',
          description: 'Revenue and cost synergy identification',
          icon: 'fas fa-handshake',
          fields: [
            { name: 'acquirer', required: true },
            { name: 'target', required: true },
            { name: 'notes', required: false }
          ]
        }
      },
      fieldLabels: {
        acquirer: 'Acquirer Company',
        target: 'Target Company',
        notes: 'Strategic Notes',
        targetIndustry: 'Target Industry',
        geography: 'Geography',
        revenueRange: 'Revenue Range',
        wacc: 'WACC (%)',
        terminalGrowth: 'Terminal Growth Rate (%)',
        taxRate: 'Tax Rate (%)',
        targetMarket: 'Target Market',
        sampleCompany: 'Sample Company for Comparison'
      },
      fieldPlaceholders: {
        acquirer: 'e.g., Microsoft Corporation',
        target: 'e.g., GitHub Inc.',
        notes: 'Any specific criteria, constraints, or strategic considerations...',
        targetIndustry: 'e.g., SaaS, Healthcare, FinTech',
        geography: 'e.g., North America, Europe, Global',
        revenueRange: 'e.g., $10M-$50M ARR',
        wacc: 'e.g., 8.5',
        terminalGrowth: 'e.g., 2.5',
        taxRate: 'e.g., 21',
        targetMarket: 'e.g., Cloud Infrastructure',
        sampleCompany: 'e.g., Snowflake, Datadog'
      },
      fieldHelpers: {
        targetIndustry: 'Leave blank to search all industries',
        geography: 'Leave blank for global search',
        revenueRange: 'Leave blank for AI-suggested range',
        wacc: 'Leave blank to use industry average (~9%)',
        terminalGrowth: 'Leave blank to use standard rate (~2.5%)',
        taxRate: 'Leave blank to use standard rate (~21%)',
        sampleCompany: 'Optional: helps AI benchmark the market',
        notes: 'Optional: add any context that would help the analysis'
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      renderModules();
      checkAPIStatus();
    });

    function setupEventListeners() {
      document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        item.addEventListener('click', () => showPage(item.dataset.page));
      });

      document.querySelectorAll('.nav-item[data-module]').forEach(item => {
        item.addEventListener('click', () => {
          showPage('analysis');
          setTimeout(() => selectModule(item.dataset.module), 100);
        });
      });

      document.getElementById('startAnalysisBtn').addEventListener('click', () => showPage('analysis'));
      document.getElementById('settingsBtn').addEventListener('click', openSettings);
      document.getElementById('closeSettings').addEventListener('click', closeSettings);
      document.getElementById('cancelSettings').addEventListener('click', closeSettings);
      document.getElementById('saveSettings').addEventListener('click', saveSettings);
      document.getElementById('runAnalysis').addEventListener('click', runAnalysis);
      document.getElementById('toggleChat').addEventListener('click', toggleChat);
      document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
      });

      // File upload
      const uploadZone = document.getElementById('uploadZone');
      const fileInput = document.getElementById('fileInput');
      uploadZone.addEventListener('click', () => fileInput.click());
      uploadZone.addEventListener('dragover', handleDragOver);
      uploadZone.addEventListener('dragleave', handleDragLeave);
      uploadZone.addEventListener('drop', handleFileDrop);
      fileInput.addEventListener('change', handleFileSelect);
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('dragover');
    }

    function handleFileDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files);
      files.forEach(uploadFile);
    }

    function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      files.forEach(uploadFile);
    }

    async function uploadFile(file) {
      if (file.size > 100 * 1024 * 1024) {
        alert(`File ${file.name} is too large (max 100MB)`);
        return;
      }
      const formData = new FormData();
      formData.append('file', file);
      try {
        const response = await fetch('/api/upload', { method: 'POST', body: formData });
        const result = await response.json();
        if (result.ok) {
          App.uploads.set(result.data.hash, { ...result.data, file: file });
          renderFileList();
        }
      } catch (error) {
        console.error('Upload error:', error);
        alert(`Failed to upload ${file.name}`);
      }
    }

    function renderFileList() {
      const container = document.getElementById('fileList');
      container.innerHTML = '';
      App.uploads.forEach((fileInfo, hash) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <div class="file-info">
            <div class="file-name">${fileInfo.name}</div>
            <div class="file-meta">${fileInfo.mime} â€¢ ${(fileInfo.size / 1024).toFixed(1)} KB</div>
          </div>
          <button class="btn btn-secondary" onclick="removeFile('${hash}')">Remove</button>
        `;
        container.appendChild(fileItem);
      });
    }

    async function removeFile(hash) {
      try {
        const response = await fetch('/api/delete_upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hash })
        });
        if ((await response.json()).ok) {
          App.uploads.delete(hash);
          renderFileList();
        }
      } catch (error) {
        console.error('Delete error:', error);
      }
    }

    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById(page)?.classList.remove('hidden');

      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      document.querySelector(`[data-page="${page}"]`)?.classList.add('active');

      const titles = { dashboard: 'Dashboard', analysis: 'New Analysis', results: 'Analysis Results' };
      document.getElementById('pageTitle').textContent = titles[page] || page;
      App.currentPage = page;
    }

    function selectModule(moduleKey) {
      App.selectedModule = moduleKey;
      document.querySelectorAll('.module-card').forEach(card => {
        card.classList.remove('selected');
        if (card.dataset.module === moduleKey) card.classList.add('selected');
      });

      renderDealContextForm();
      document.getElementById('dealContextCard').classList.remove('hidden');
      document.getElementById('runAnalysis').disabled = !App.apiKey;
    }

    function renderDealContextForm() {
      const config = App.moduleConfig[App.selectedModule];
      if (!config) return;

      const formContainer = document.getElementById('dealContextForm');
      formContainer.innerHTML = '';

      config.fields.forEach(field => {
        const fieldDiv = document.createElement('div');
        if (field.name === 'notes') fieldDiv.className = 'col-span-2';

        const label = document.createElement('label');
        label.className = 'form-label';
        label.innerHTML = `
          ${App.fieldLabels[field.name]}
          ${field.required ? '<span class="required">*</span>' : '<span class="optional">(optional)</span>'}
        `;

        let input;
        if (field.name === 'notes') {
          input = document.createElement('textarea');
          input.className = 'form-textarea';
          input.rows = 3;
        } else {
          input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-input';
        }

        input.id = field.name;
        input.placeholder = App.fieldPlaceholders[field.name] || '';
        input.value = App.formData[field.name] || '';
        input.addEventListener('input', (e) => {
          App.formData[field.name] = e.target.value;
        });

        fieldDiv.appendChild(label);
        fieldDiv.appendChild(input);

        if (App.fieldHelpers[field.name]) {
          const helper = document.createElement('div');
          helper.className = 'form-helper';
          helper.textContent = App.fieldHelpers[field.name];
          fieldDiv.appendChild(helper);
        }

        formContainer.appendChild(fieldDiv);
      });
    }

    function renderModules() {
      const containers = [document.getElementById('dashboardModules'), document.getElementById('moduleSelector')];
      containers.forEach(container => {
        if (!container) return;
        container.innerHTML = '';
        Object.entries(App.moduleConfig).forEach(([key, config]) => {
          const moduleCard = document.createElement('div');
          moduleCard.className = 'module-card';
          moduleCard.dataset.module = key;
          moduleCard.innerHTML = `
            <div class="module-icon"><i class="${config.icon}"></i></div>
            <div class="module-name">${config.label}</div>
            <div class="module-desc">${config.description}</div>
          `;
          moduleCard.addEventListener('click', () => {
            if (container === containers[0]) {
              showPage('analysis');
              setTimeout(() => selectModule(key), 100);
            } else {
              selectModule(key);
            }
          });
          container.appendChild(moduleCard);
        });
      });
    }

    function checkAPIStatus() {
      const statusEl = document.getElementById('aiStatus');
      const dot = statusEl.querySelector('.status-dot');
      if (App.apiKey) {
        statusEl.className = 'status-badge status-success';
        statusEl.querySelector('span').textContent = 'AI Ready';
        dot.style.background = 'var(--success)';
      } else {
        statusEl.className = 'status-badge status-warning';
        statusEl.querySelector('span').textContent = 'API Key Required';
        dot.style.background = 'var(--warn)';
      }
    }

    async function runAnalysis() {
      if (!App.apiKey) {
        alert('Please set your OpenAI API key in settings');
        return;
      }
      if (!App.selectedModule) {
        alert('Please select an analysis module');
        return;
      }

      const button = document.getElementById('runAnalysis');
      button.disabled = true;
      button.innerHTML = '<div class="spinner"></div> Analyzing...';

      try {
        const response = await fetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            module: App.selectedModule,
            ...App.formData,
            upload_hashes: Array.from(App.uploads.keys()),
            api_key: App.apiKey
          })
        });

        const result = await response.json();
        if (result.ok) {
          App.analysisResult = result.data.analysis;
          document.getElementById('resultContent').textContent = result.data.analysis;
          showPage('results');
          App.chatMessages = [];
          renderChatMessages();
        } else {
          throw new Error(result.detail || 'Analysis failed');
        }
      } catch (error) {
        console.error('Analysis error:', error);
        alert(`Analysis failed: ${error.message}`);
      } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-play"></i> Run Analysis';
      }
    }

    function toggleChat() {
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.classList.toggle('hidden');
    }

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();

      if (!message || !App.apiKey) return;

      App.chatMessages.push({ role: 'user', content: message });
      renderChatMessages();
      input.value = '';

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            api_key: App.apiKey,
            context: App.analysisResult.substring(0, 2000)
          })
        });

        const result = await response.json();
        if (result.ok) {
          App.chatMessages.push({ role: 'assistant', content: result.data.response });
          renderChatMessages();
        }
      } catch (error) {
        console.error('Chat error:', error);
      }
    }

    function renderChatMessages() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = '';

      App.chatMessages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${msg.role}`;

        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'chat-bubble';
        bubbleDiv.textContent = msg.content;

        messageDiv.appendChild(bubbleDiv);
        container.appendChild(messageDiv);
      });

      container.scrollTop = container.scrollHeight;
    }

    function openSettings() {
      document.getElementById('settingsModal').classList.add('active');
      document.getElementById('apiKeyInput').value = App.apiKey;
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('active');
    }

    function saveSettings() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      App.apiKey = apiKey;
      localStorage.setItem('openai_api_key', apiKey);
      checkAPIStatus();
      closeSettings();
      alert('Settings saved successfully');
      if (App.selectedModule) {
        document.getElementById('runAnalysis').disabled = !apiKey;
      }
    }
</script>
</body>
</html>